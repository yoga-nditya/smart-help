<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Customer</title>
</head>
<body>
  <h2>Customer Video & Chat</h2>
  <video id="local" autoplay muted></video>
  <video id="remote" autoplay></video>
  <div>
    <input id="msg" placeholder="Chat here" />
    <button onclick="sendChat()">Send</button>
  </div>
  <div id="chatlog"></div>

  <script>
    const ws = new WebSocket("wss://webrtc.lippomallpuri.com/ws/available-rooms?client_id=1bfaswK8zZ&client_secret=JO7Ztf0Fp1VUQRgwWAi1Cr0SJQL3mUu1");
    let roomId = null;
    let pc = new RTCPeerConnection();

    ws.onmessage = async e => {
      const data = JSON.parse(e.data);

      if (data.type === "room_ready") {
        roomId = data.UserRoleId.toString();
        ws.send(JSON.stringify({ type: "room_join", UserRoleId: roomId }));
        startWebRTC();
      } else if (data.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data));
      } else if (data.type === "candidate") {
        pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      } else if (data.type === "chat") {
        document.getElementById("chatlog").innerHTML += `<div>Agent: ${data.message}</div>`;
      }
    };

    pc.onicecandidate = event => {
      if (event.candidate) {
        ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate, room: roomId }));
      }
    };

    pc.ontrack = e => {
      document.getElementById("remote").srcObject = e.streams[0];
    };

    async function startWebRTC() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      stream.getTracks().forEach(t => pc.addTrack(t, stream));
      document.getElementById("local").srcObject = stream;
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp, room: roomId }));
    }

    function sendChat() {
      const msg = document.getElementById("msg").value;
      ws.send(JSON.stringify({ type: "chat", message: msg, room: roomId }));
      document.getElementById("chatlog").innerHTML += `<div>You: ${msg}</div>`;
      document.getElementById("msg").value = "";
    }
  </script>
</body>
</html>
